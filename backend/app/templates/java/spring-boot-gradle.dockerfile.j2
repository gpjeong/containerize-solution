# Spring Boot Gradle Project Dockerfile
# Generated by Dockerfile Generator

# Stage 1: Build
FROM gradle:8.5-jdk{{ runtime_version }}-alpine AS build

WORKDIR /app

# Copy gradle files first (for better caching)
COPY build.gradle settings.gradle ./
COPY gradle ./gradle

# Download dependencies
RUN gradle dependencies --no-daemon

# Copy source code
COPY src ./src

# Build application
RUN gradle bootJar --no-daemon

# Stage 2: Runtime
FROM eclipse-temurin:{{ runtime_version }}-jre-alpine AS runtime

# Install system dependencies
{% if system_dependencies %}
RUN apk add --no-cache {{ system_dependencies | join(' ') }}
{% endif %}

# Create non-root user
RUN addgroup -S {{ user }} && adduser -S {{ user }} -G {{ user }}

WORKDIR /app

# Copy built JAR from build stage
COPY --from=build --chown={{ user }}:{{ user }} /app/build/libs/*.jar app.jar

# Switch to non-root user
USER {{ user }}

# Set environment variables
{% if environment_vars %}
{% for key, value in environment_vars.items() %}
ENV {{ key }}="{{ value }}"
{% endfor %}
{% endif %}
{% if service_url %}
ENV SERVICE_URL="{{ service_url }}"
{% endif %}

# Expose port
EXPOSE {{ port }}

# Health check
{% if health_check_path %}
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:{{ port }}{{ health_check_path }} || exit 1
{% endif %}

# Run Spring Boot application
{% if custom_start_command %}
CMD [{{ custom_start_command.split() | map('tojson') | join(', ') }}]
{% else %}
ENTRYPOINT ["java", {{ jvm_options | split_jvm_options | map('tojson') | join(', ') }}, "-jar", "app.jar"]
{% endif %}
