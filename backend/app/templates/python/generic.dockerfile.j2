# Python Web Application Dockerfile
# Generated by Dockerfile Generator

FROM {{ base_image }}

# Install system dependencies
{% if system_dependencies %}
RUN apt-get update && apt-get install -y {{ system_dependencies | join(' ') }} \
    && rm -rf /var/lib/apt/lists/*
{% endif %}

# Create non-root user
RUN useradd -m -u 1000 {{ user }} && \
    mkdir -p /app && \
    chown -R {{ user }}:{{ user }} /app

WORKDIR /app

# Copy application files
COPY --chown={{ user }}:{{ user }} . .

# Install Python dependencies if requirements.txt exists
RUN if [ -f requirements.txt ]; then \
        pip install --no-cache-dir -r requirements.txt; \
    fi

# Switch to non-root user
USER {{ user }}

# Set environment variables
{% if environment_vars %}
{% for key, value in environment_vars.items() %}
ENV {{ key }}="{{ value }}"
{% endfor %}
{% endif %}
{% if service_url %}
ENV SERVICE_URL="{{ service_url }}"
{% endif %}

# Expose port
EXPOSE {{ port }}

# Health check
{% if health_check_path %}
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD curl --fail http://localhost:{{ port }}{{ health_check_path }} || exit 1
{% endif %}

# Run application with custom command
{% if custom_start_command %}
CMD [{{ custom_start_command.split() | map('tojson') | join(', ') }}]
{% else %}
CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "{{ port }}"]
{% endif %}
