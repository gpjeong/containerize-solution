# Flask Application Dockerfile
# Generated by Dockerfile Generator

FROM {{ base_image }} AS base

# Install system dependencies
{% if system_dependencies %}
RUN apt-get update && apt-get install -y \
    {{ system_dependencies | join(' \\\n    ') }} \
    && rm -rf /var/lib/apt/lists/*
{% endif %}

# Create non-root user
RUN groupadd -r {{ user }} && useradd -r -g {{ user }} {{ user }}

# Set working directory
WORKDIR /app

# Copy requirements first (for better caching)
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Change ownership to non-root user
RUN chown -R {{ user }}:{{ user }} /app

# Switch to non-root user
USER {{ user }}

# Set environment variables
{% for key, value in environment_vars.items() %}
ENV {{ key }}="{{ value }}"
{% endfor %}
{% if service_url %}
ENV SERVICE_URL="{{ service_url }}"
{% endif %}
ENV FLASK_APP={{ entrypoint_file }}

# Expose port
EXPOSE {{ port }}

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:{{ port }}{{ health_check_path }}')" || exit 1

# Run application with gunicorn
{% if custom_start_command %}
CMD {{ custom_start_command.split() | map('tojson') | join(', ') }}
{% else %}
CMD ["gunicorn", "--bind", "0.0.0.0:{{ port }}", "--workers", "4", "{{ entrypoint_file.replace('.py', '') }}:app"]
{% endif %}
