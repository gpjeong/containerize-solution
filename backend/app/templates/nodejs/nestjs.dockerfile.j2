# NestJS Application Dockerfile
# Generated by Dockerfile Generator

# Stage 1: Dependencies
FROM {{ base_image }} AS deps

WORKDIR /app

# Copy package files
COPY package*.json ./
{% if package_manager == 'yarn' %}
COPY yarn.lock ./
RUN yarn install --frozen-lockfile
{% elif package_manager == 'pnpm' %}
COPY pnpm-lock.yaml ./
RUN corepack enable && pnpm install --frozen-lockfile
{% else %}
RUN npm ci
{% endif %}

# Stage 2: Builder
FROM {{ base_image }} AS builder

WORKDIR /app

# Copy dependencies
COPY --from=deps /app/node_modules ./node_modules

# Copy source code
COPY . .

# Build application
{% if build_command %}
RUN {{ build_command }}
{% else %}
RUN npm run build
{% endif %}

# Stage 3: Runtime
FROM {{ base_image }} AS runtime

# Install system dependencies
{% if system_dependencies %}
RUN apk add --no-cache {{ system_dependencies | join(' ') }}
{% endif %}

# Create non-root user
RUN addgroup -S {{ user }} && adduser -S {{ user }} -G {{ user }}

WORKDIR /app

# Copy production dependencies
COPY --from=deps --chown={{ user }}:{{ user }} /app/node_modules ./node_modules

# Copy built application
COPY --from=builder --chown={{ user }}:{{ user }} /app/dist ./dist
COPY --chown={{ user }}:{{ user }} package*.json ./

# Switch to non-root user
USER {{ user }}

# Set environment variables
{% for key, value in environment_vars.items() %}
ENV {{ key }}="{{ value }}"
{% endfor %}
{% if service_url %}
ENV SERVICE_URL="{{ service_url }}"
{% endif %}

# Expose port
EXPOSE {{ port }}

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:{{ port }}{{ health_check_path }} || exit 1

# Run application
{% if custom_start_command %}
CMD [{{ custom_start_command.split() | map('tojson') | join(', ') }}]
{% else %}
CMD [{{ start_command.split() | map('tojson') | join(', ') }}]
{% endif %}
