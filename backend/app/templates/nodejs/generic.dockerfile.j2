# Node.js Web Application Dockerfile
# Generated by Dockerfile Generator

FROM {{ base_image }}

# Install system dependencies
{% if system_dependencies %}
RUN apk add --no-cache {{ system_dependencies | join(' ') }}
{% endif %}

# Create non-root user
RUN addgroup -S {{ user }} && adduser -S {{ user }} -G {{ user }} && \
    mkdir -p /app && \
    chown -R {{ user }}:{{ user }} /app

WORKDIR /app

# Copy package files
COPY --chown={{ user }}:{{ user }} package*.json ./

# Install dependencies
RUN npm install --production

# Copy application files
COPY --chown={{ user }}:{{ user }} . .

# Build if needed (for TypeScript, Next.js, etc.)
RUN if [ -f "tsconfig.json" ] || [ -d ".next" ]; then \
        npm run build 2>/dev/null || true; \
    fi

# Switch to non-root user
USER {{ user }}

# Set environment variables
{% if environment_vars %}
{% for key, value in environment_vars.items() %}
ENV {{ key }}="{{ value }}"
{% endfor %}
{% endif %}
{% if service_url %}
ENV SERVICE_URL="{{ service_url }}"
{% endif %}

# Expose port
EXPOSE {{ port }}

# Health check
{% if health_check_path %}
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:{{ port }}{{ health_check_path }} || exit 1
{% endif %}

# Run application with custom command
{% if custom_start_command %}
CMD [{{ custom_start_command.split() | map('tojson') | join(', ') }}]
{% else %}
CMD ["npm", "start"]
{% endif %}
